# Makefile - liblos
# Marty Olevitch, Jul '05
# GNU make only, I think.

include ${ANITA_FLIGHT_SOFT_DIR}/standard_definitions.mk


VERSION = $(shell cat VERSION)
#PREFIX = /pkgs/liblos-$(VERSION)
#PREFIX = /usr/local

#PLX_SDK_DIR = /home/marty/src/anita/plx/PlxLinux

# Stuff needed for PLX compilation
ifndef PLX_SDK_DIR
    $(warning Warning: Variable 'PLX_SDK_DIR' not set using ${ANITA_FLIGHT_SOFT_DIR}/outside/surfTurf/PlxLinux/ for compilation)
	PLX_SDK_DIR=${ANITA_FLIGHT_SOFT_DIR}/outside/surfTurf/PlxLinux
endif

#PLX_SDK_DIR = /usr/local/PlxLinux
COMMON_DIR = $(PLX_SDK_DIR)/linux/samples/common
INCLUDE_DIR = $(PLX_SDK_DIR)/include

INCLUDE = -I. -I$(INCLUDE_DIR) -I$(COMMON_DIR)

DEFS = -DGCC  -DPCI_CODE -DPLX_LITTLE_ENDIAN -DPLX_LINUX
#OPTS = -Wall -pipe -O2
OPTS = -Wall -pipe -g
CC = gcc
PLX_CFLAGS = $(DEFS) $(INCLUDE) $(OPTS)
CCFLAGS:= ${CCFLAGS} ${PLX_CFLAGS}

PLX_LIBS = $(PLX_SDK_DIR)/linux/api/Library/PlxApi.a \
	$(PLX_SDK_DIR)/linux/PciDrvApi/Library/PciDrvApi.a 

OBJS = los.o crc_simple.o
HDRS = los.h crc_simple.h

#ND = /usr/local/src/new/naturaldocs-1.35/NaturalDocs

Target       = $(ANITA_LIB_DIR)/libLos.a

all: $(Target)

$(Target): $(OBJS)
	@/bin/rm -f $(Target)
	@ar -r $@ $^

#liblos.a:	$(OBJS) $(HDRS)
#	ar r liblos.a $(OBJS)

los.o:	los.h version.h
crc_simple.o:	crc_simple.h

version.h:	VERSION version.h.in
	@sed "s/@VERSION@/$(VERSION)/" version.h.in > version.h

los.txt:	los.txt.in VERSION
	echo "DO NOT EDIT THIS FILE. Edit los.txt.in instead." > los.txt
	echo >> los.txt
	@sed "s/@VERSION@/$(VERSION)/" los.txt.in >> los.txt

demo:	demo.c $(Target) los.h
	$(CC) $(CFLAGS) -o demo demo.c $(LDFLAGS) $(ANITA_LOS_LIBS) $(PLX_LIBS) -lncurses

clean:
	@rm -f $(Target) $(OBJS) version.h demo los.txt

docs:	los.txt
	$(ND) -i . -o html ./doc -p ./ndinfo -s mydefault

#install: liblos.a
#	mkdir -p $(PREFIX)/include $(PREFIX)/lib
#	cp liblos.a $(PREFIX)/lib
#	cp los.h $(PREFIX)/include
#	@echo Remember to run graft -i $(PREFIX)
